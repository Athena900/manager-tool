# 🚨 RLS緊急修正ガイド

## 現在の問題

- **症状**: RLSが正常に動作せず、複数のuser_IDのデータが混在
- **影響**: データ分離が不完全、セキュリティリスク
- **緊急度**: 最高

## 修正手順

### 1. 現在の状態を診断

1. **開発環境にアクセス**: https://manager-tool.vercel.app/
2. **メインページの「概要」タブを確認**
3. **「🚨 RLS緊急診断ツール」セクションで「RLS状態を診断」ボタンをクリック**

期待される結果:
```
明示的フィルター: 1件
RLSのみ: 9件  ← 問題！同じ件数であるべき
RLSステータス: ❌ 異常
```

### 2. Supabaseダッシュボードでの修正

1. **Supabaseダッシュボードにログイン**
   - URL: https://app.supabase.com/project/csnkakkzcpamycuvrtqk

2. **SQL Editorを開く**
   - 左側メニューから「SQL Editor」を選択

3. **RLS修正SQLを実行**
   - `/database/006_rls_emergency_fix.sql`の内容をコピー
   - SQL Editorに貼り付けて「Run」をクリック

### 3. 修正内容の詳細

修正SQLは以下の処理を実行します:

1. **既存RLSポリシーの完全削除**
   - すべての既存ポリシーを削除

2. **RLSの再初期化**
   - 一時的に無効化してから再有効化

3. **新しいシンプルなポリシー作成**
   ```sql
   -- 例: salesテーブル
   CREATE POLICY "sales_select_policy" ON sales
       FOR SELECT
       USING (auth.uid() = user_id);
   ```

4. **不正データのクリーンアップ**
   - オーナー以外のデータを削除
   - NULL user_idのデータを削除

5. **インデックスの再作成**
   - パフォーマンス向上のため

### 4. 修正後の確認

1. **アプリケーションに戻る**
2. **再度「RLS状態を診断」を実行**

期待される結果:
```
明示的フィルター: 6件
RLSのみ: 6件  ← 正常！同じ件数
RLSステータス: ✅ 正常
検出されたuser_ID数: 1種類
```

### 5. 追加の確認事項

#### Supabaseダッシュボードでの確認

1. **Table Editor**で`sales`テーブルを確認
   - すべてのレコードが同じuser_idを持つこと
   - user_id: `635c35fb-0159-4bb9-9ab8-8933eb04ee31`

2. **Authentication > Policies**でRLSポリシーを確認
   - salesテーブルに4つのポリシー（select, insert, update, delete）
   - profilesテーブルに4つのポリシー

### 6. トラブルシューティング

#### 修正後も問題が残る場合

1. **ブラウザキャッシュをクリア**
2. **ログアウトして再ログイン**
3. **Supabaseのキャッシュをクリア**（Settings > Database > Clear cache）

#### エラーが発生した場合

- **権限エラー**: Supabaseプロジェクトの管理者権限を確認
- **構文エラー**: SQLの各ステートメントを個別に実行

### 7. 本番環境への適用

修正が開発環境で確認できたら:

1. **本番環境でも同じ手順を実行**
2. **すべてのユーザーに影響することを事前に通知**
3. **実行時間は数秒で完了**

## 重要な注意事項

⚠️ **データの削除について**
- このスクリプトはオーナー以外のデータを削除します
- 実行前に必要に応じてバックアップを取ってください

⚠️ **実行タイミング**
- ユーザーのアクセスが少ない時間帯に実行推奨
- 実行中は一時的にデータアクセスエラーが発生する可能性

## 完了後のアクション

1. ✅ RLS診断ツールで正常動作を確認
2. ✅ 新規ユーザー登録でデータ分離をテスト
3. ✅ 既存ユーザーのデータアクセスを確認
4. ✅ 本番環境でも同様の確認を実施

---

**緊急連絡先**: 問題が発生した場合は即座に開発チームに連絡してください。